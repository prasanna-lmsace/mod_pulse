{"version":3,"sources":["../src/preset.js"],"names":["define","$","Modal","ModalPreset","PresetEvents","Str","Fragment","AJAX","Templates","Loadingicon","Notification","ModalEvents","Preset","contextId","courseid","pageparams","loadPresetsList","prototype","listElement","loadIconElement","actionbuttons","setupmodal","THIS","triggerelement","document","querySelectorAll","forEach","element","addEventListener","presetid","getAttribute","presettitle","params","create","type","TYPE","title","get_string","body","loadFragment","large","then","modal","show","getRoot","on","hidden","destroy","bind","customize","modform","forms","modformdata","FormData","get","form","formdata","URLSearchParams","toString","addIconToContainer","disableButtons","applyCustomize","save","e","preventDefault","restorePreset","catch","exception","contextID","done","html","js","handleFormSubmissionResponse","buttons","$i","disabled","data","newform","createElement","innerHTML","replaceNode","contextid","formdatastr","promises","call","methodname","args","response","JSON","parse","url","window","location","href","listParent","getElementById","selector","loaded","replaceNodeContents","setAttribute","init"],"mappings":"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","sourcesContent":["define(['jquery', 'core/modal_factory', 'mod_pulse/modal_preset', 'mod_pulse/events', 'core/str',\n'core/fragment', 'core/ajax', 'core/templates', 'core/loadingicon', 'core/notification', 'core/modal_events'],\n    function($, Modal, ModalPreset, PresetEvents, Str, Fragment, AJAX, Templates, Loadingicon, Notification, ModalEvents) {\n\n\n    var Preset = function(contextId, courseid, pageparams) {\n        this.contextId = contextId;\n        this.courseid = courseid;\n        this.pageparams = pageparams;\n        this.loadPresetsList();\n    };\n\n    Preset.prototype.listElement = {'selector' : 'pulse-presets-data',  \"loaded\": \"data-listloaded\"};\n\n    Preset.prototype.contextId = 0;\n\n    Preset.prototype.courseid = 0;\n\n    Preset.prototype.pageparams = [];\n\n    Preset.prototype.loadIconElement = '.modal-footer #loader-icon';\n\n    Preset.prototype.actionbuttons = '.modal-footer button';\n\n    Preset.prototype.setupmodal = function() {\n\n        var THIS = this;\n\n        var triggerelement = document.querySelectorAll('.pulse-usepreset');\n        triggerelement.forEach((element) => element.addEventListener('click', () => {\n            var presetid = element.getAttribute('data-presetid');\n            var presettitle = element.getAttribute('data-presettitle');\n            var params = {'presetid': presetid, 'courseid': THIS.courseid};\n            Modal.create({\n                type: ModalPreset.TYPE,\n                title: Str.get_string('presetmodaltitle', 'pulse', {'title': presettitle}),\n                body: Fragment.loadFragment('mod_pulse', 'get_preset_preview', THIS.contextId, params),\n                large: true\n            }).then(modal => {\n                modal.show();\n                // Destroy the modal on hidden to reload the editors.\n                modal.getRoot().on(ModalEvents.hidden, modal.destroy.bind(modal));\n\n                modal.getRoot().on(PresetEvents.customize, () => {\n                    var modform = document.forms[0];\n                    var modformdata = new FormData(modform);\n                    modal.getRoot().get(0).querySelectorAll('form').forEach(form => {\n                        var formdata = new FormData(form);\n                        formdata = new URLSearchParams(formdata).toString();\n                        var pageparams = new URLSearchParams(modformdata).toString();\n                        params = {formdata: formdata, pageparams: pageparams};\n\n                        Loadingicon.addIconToContainer(this.loadIconElement);\n                        THIS.disableButtons();\n                        THIS.applyCustomize(params, THIS.contextId, modal);\n                    });\n                });\n\n                modal.getRoot().on(PresetEvents.save, (e) => {\n                    e.preventDefault();\n                    Loadingicon.addIconToContainer(this.loadIconElement);\n                    THIS.disableButtons();\n                    var formdata = {};\n                    modal.getRoot().get(0).querySelectorAll('form').forEach(form => {\n                        formdata = new FormData(form);\n                        this.restorePreset(formdata, THIS.contextId);\n                    });\n                });\n                return true;\n            }).catch(Notification.exception);\n        }));\n\n    };\n\n    Preset.prototype.applyCustomize = function(params, contextID, modal) {\n        Fragment.loadFragment('mod_pulse', 'apply_preset', contextID, params).done((html, js) => {\n            this.handleFormSubmissionResponse(html, js);\n            modal.destroy();\n        });\n    };\n\n    Preset.prototype.disableButtons = function() {\n        var buttons = document.querySelectorAll(this.actionbuttons);\n        for (let $i in buttons) {\n            buttons[$i].disabled = true;\n        }\n    };\n\n    Preset.prototype.handleFormSubmissionResponse = (data, js) => {\n        var newform = document.createElement('div');\n        newform.innerHTML = data;\n        Templates.replaceNode('[action=\"modedit.php\"]', data, js);\n    };\n\n    Preset.prototype.restorePreset = (formdata, contextid) => {\n        var formdatastr = new URLSearchParams(formdata).toString();\n        var promises = AJAX.call([{\n            methodname: 'mod_pulse_apply_presets',\n            args: {contextid: contextid, formdata: formdatastr}\n        }]);\n\n        promises[0].done((response) => {\n            response = JSON.parse(response);\n            if (typeof response.url != 'undefined') {\n                window.location.href = response.url;\n            }\n        });\n    };\n\n    /**\n     * Load list of available presets.\n     */\n    Preset.prototype.loadPresetsList = function() {\n        var listParent = document.getElementById(this.listElement.selector);\n\n        if (listParent !== null) {\n            if (listParent.getAttribute(this.listElement.loaded) == 'false') {\n                Fragment.loadFragment('mod_pulse', 'get_presetslist', this.contextId, {'courseid': this.courseid})\n                .done((html, js) => {\n                    Templates.replaceNodeContents(listParent, html, js);\n                    listParent.setAttribute(this.listElement.loaded, 'true');\n                    this.setupmodal();\n                });\n            }\n        }\n    };\n\n    return {\n        init: (contextId, courseid) => {\n            new Preset(contextId, courseid);\n        }\n    };\n});\n"],"file":"preset.min.js"}