{"version":3,"sources":["../src/preset.js"],"names":["define","$","Modal","ModalPreset","PresetEvents","Str","Fragment","AJAX","Templates","Loadingicon","Notification","ModalEvents","SELECTOR","presetAvailability","Preset","contextId","courseid","section","loadPresetsList","prototype","listElement","pageparams","loadIconElement","actionbuttons","setupmodal","THIS","triggerelement","document","querySelectorAll","attachmentPoint","createElement","classList","add","forEach","element","addEventListener","presetid","getAttribute","presettitle","params","body","prepend","create","type","TYPE","title","get_string","loadFragment","large","then","modal","show","getRoot","on","bodyRendered","reinitAvailability","hidden","destroy","bind","customize","modform","querySelector","modformdata","FormData","get","form","formdata","URLSearchParams","toString","addIconToContainer","disableButtons","applyCustomize","save","e","preventDefault","restorePreset","catch","exception","selector","M","core_availability","resetRestrictPlugins","field","parentNode","removeChild","init","getElementById","restrictByGroup","availabilityPlugins","plugins","plugin","i","hasOwnProperty","addedEvents","contextID","done","html","js","handleFormSubmissionResponse","buttons","$i","disabled","data","newform","innerHTML","replaceNode","contextid","formdatastr","promises","call","methodname","args","response","JSON","parse","url","window","location","href","listParent","loaded","replaceNodeContents","setAttribute"],"mappings":"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","sourcesContent":["define(['jquery', 'core/modal_factory', 'mod_pulse/modal_preset', 'mod_pulse/events', 'core/str',\n'core/fragment', 'core/ajax', 'core/templates', 'core/loadingicon', 'core/notification', 'core/modal_events'],\n    function($, Modal, ModalPreset, PresetEvents, Str, Fragment, AJAX, Templates, Loadingicon, Notification, ModalEvents) {\n\n    var SELECTOR = {\n        presetAvailability: '.preset-config-params .availability-field'\n    };\n\n    /**\n     * Preset module declaration. Setup the global values.\n     * @param  {int} contextId\n     * @param  {int} courseid\n     * @param  {int} section\n     */\n    var Preset = function(contextId, courseid, section) {\n        this.contextId = contextId;\n        this.courseid = courseid;\n        this.section = section;\n        this.loadPresetsList();\n    };\n\n    Preset.prototype.listElement = {'selector': 'pulse-presets-data', \"loaded\": \"data-listloaded\"};\n\n    Preset.prototype.contextId = 0;\n\n    Preset.prototype.courseid = 0;\n\n    Preset.prototype.section = 0;\n\n    Preset.prototype.pageparams = [];\n\n    Preset.prototype.loadIconElement = '.modal-footer #loader-icon';\n\n    Preset.prototype.actionbuttons = '.modal-footer button';\n\n    /**\n     * Setup the presets modal event listeners.\n     */\n    Preset.prototype.setupmodal = function() {\n\n        var THIS = this;\n\n        var triggerelement = document.querySelectorAll('.pulse-usepreset');\n        // Modal attachment point.\n        var attachmentPoint = document.createElement('div');\n        attachmentPoint.classList.add('modal-preset');\n        triggerelement.forEach((element) => element.addEventListener('click', () => {\n            var presetid = element.getAttribute('data-presetid');\n            var presettitle = element.getAttribute('data-presettitle');\n            var params = {'presetid': presetid, 'courseid': THIS.courseid, 'section': THIS.section};\n\n            document.body.prepend(attachmentPoint);\n            Modal.create({\n                type: ModalPreset.TYPE,\n                title: Str.get_string('presetmodaltitle', 'pulse', {'title': presettitle}),\n                body: Fragment.loadFragment('mod_pulse', 'get_preset_preview', THIS.contextId, params),\n                large: true,\n            }).then(modal => {\n                // Make the modal attachment point to overcome the restriction access condition.\n                modal.attachmentPoint = attachmentPoint;\n                modal.show();\n                modal.getRoot().on(ModalEvents.bodyRendered, function() {\n                    THIS.reinitAvailability(SELECTOR.presetAvailability);\n                });\n                // Destroy the modal on hidden to reload the editors.\n                modal.getRoot().on(ModalEvents.hidden, function() {\n                    modal.destroy.bind(modal);\n                    THIS.reinitAvailability();\n                });\n                // Apply and customize method.\n                modal.getRoot().on(PresetEvents.customize, () => {\n                    var modform = document.querySelector('#mod-pulse-form');\n                    var modformdata = new FormData(modform);\n                    modal.getRoot().get(0).querySelectorAll('form').forEach(form => {\n                        var formdata = new FormData(form);\n                        formdata = new URLSearchParams(formdata).toString();\n                        var pageparams = new URLSearchParams(modformdata).toString();\n                        params = {formdata: formdata, pageparams: pageparams};\n\n                        Loadingicon.addIconToContainer(this.loadIconElement);\n                        THIS.disableButtons();\n                        THIS.applyCustomize(params, THIS.contextId, modal);\n                    });\n                });\n                // Apply and save method.\n                modal.getRoot().on(PresetEvents.save, (e) => {\n                    e.preventDefault();\n                    Loadingicon.addIconToContainer(this.loadIconElement);\n                    THIS.disableButtons();\n                    var formdata = {};\n                    modal.getRoot().get(0).querySelectorAll('form').forEach(form => {\n                        formdata = new FormData(form);\n                        this.restorePreset(formdata, THIS.contextId);\n                    });\n                });\n                return true;\n            }).catch(Notification.exception);\n        }));\n    };\n\n    /**\n     * Reinitialize the availability javascript.\n     * @param {string} selector\n     */\n    Preset.prototype.reinitAvailability = function(selector = '.availability-field') {\n        if (typeof M.core_availability.form !== \"undefined\") {\n            this.resetRestrictPlugins();\n            document.querySelectorAll(selector).forEach((field) => field.parentNode.removeChild(field));\n            M.core_availability.form.init();\n        }\n    };\n\n    Preset.prototype.resetRestrictPlugins = function() {\n        if (typeof M.core_availability.form !== \"undefined\" && document.getElementById('id_availabilityconditionsjson') !== null) {\n            M.core_availability.form.restrictByGroup = null;\n            var availabilityPlugins = (typeof M.core_availability.form.plugins !== 'undefined')\n                ? M.core_availability.form.plugins : {};\n            var plugin = '';\n            for (var i in availabilityPlugins) {\n                plugin = \"availability_\" + i;\n                if (M.hasOwnProperty(plugin)) {\n                    M[plugin].form.addedEvents = false;\n                }\n            }\n        }\n    };\n\n    /**\n     * Apply and customize triggered using fragment. Response will replaced with current mod form.\n     * @param  {string} params\n     * @param  {int} contextID\n     * @param  {object} modal\n     */\n    Preset.prototype.applyCustomize = function(params, contextID, modal) {\n        Fragment.loadFragment('mod_pulse', 'apply_preset', contextID, params).done((html, js) => {\n            modal.destroy();\n            // Reset the availability to work for upcoming response html.\n            this.resetRestrictPlugins();\n            this.handleFormSubmissionResponse(html, js);\n        });\n    };\n\n    /**\n     * Disable the modal save and customize buttons to prevent reinit.\n     */\n    Preset.prototype.disableButtons = function() {\n        var buttons = document.querySelectorAll(this.actionbuttons);\n        for (let $i in buttons) {\n            buttons[$i].disabled = true;\n        }\n    };\n\n    /**\n     * Handle the loaded fragment output of customize method pulse mod.\n     * @param  {html} data\n     * @param  {string} js\n     */\n    Preset.prototype.handleFormSubmissionResponse = (data, js) => {\n        var newform = document.createElement('div');\n        newform.innerHTML = data;\n        Templates.replaceNode('[action=\"modedit.php\"]', data, js);\n\n    };\n\n    /**\n     * Initiate the apply and save method to create the pulse module with custom daa.\n     * @param  {FormData} formdata\n     * @param  {int} contextid\n     */\n    Preset.prototype.restorePreset = (formdata, contextid) => {\n        var formdatastr = new URLSearchParams(formdata).toString();\n        var promises = AJAX.call([{\n            methodname: 'mod_pulse_apply_presets',\n            args: {contextid: contextid, formdata: formdatastr}\n        }]);\n\n        promises[0].done((response) => {\n            response = JSON.parse(response);\n            if (typeof response.url != 'undefined') {\n                window.location.href = response.url;\n            }\n        });\n    };\n\n    /**\n     * Load list of available presets.\n     */\n    Preset.prototype.loadPresetsList = function() {\n        var listParent = document.getElementById(this.listElement.selector);\n\n        if (listParent !== null) {\n            if (listParent.getAttribute(this.listElement.loaded) == 'false') {\n                Fragment.loadFragment('mod_pulse', 'get_presetslist', this.contextId, {'courseid': this.courseid})\n                .done((html, js) => {\n                    Templates.replaceNodeContents(listParent, html, js);\n                    listParent.setAttribute(this.listElement.loaded, 'true');\n                    this.setupmodal();\n                });\n            }\n        }\n    };\n\n    return {\n        init: (contextId, courseid, section) => {\n            new Preset(contextId, courseid, section);\n        }\n    };\n});\n"],"file":"preset.min.js"}