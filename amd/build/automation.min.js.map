{"version":3,"file":"automation.min.js","sources":["../src/automation.js"],"sourcesContent":["define(\"mod_pulse/automation\", ['jquery', 'core/modal_factory', 'core/templates', 'core/str'], function($, Modal, Template, Str) {\n\n    const moveOutMoreMenu = (navMenu) => {\n\n        if (navMenu === null) {\n            return;\n        }\n\n        var menu = navMenu.querySelector('a.automation-templates');\n\n        if (menu === null) {\n            return;\n        }\n\n        menu = menu.parentNode;\n        menu.dataset.forceintomoremenu = false;\n        menu.querySelector('a').classList.remove('dropdown-item');\n        menu.querySelector('a').classList.add('nav-link');\n        menu.parentNode.removeChild(menu);\n\n        // Insert the stored menus before the more menu.\n        navMenu.insertBefore(menu, navMenu.children[1]);\n        window.dispatchEvent(new Event('resize')); // Dispatch the resize event to create more menu.\n    };\n\n    const returnToFailedTab = () => {\n\n        if (document.forms['pulse-automation-template'] === null) {\n            return false;\n        }\n\n        document.forms['pulse-automation-template'].onsubmit = (e) => {\n            var form = e.target;\n            var invalidElement = form.querySelector('.is-invalid');\n            if (invalidElement === null) {\n                return true;\n            }\n\n            var tabid = invalidElement.parentNode.parentNode.parentNode.id;\n            var hrefSelector = '[href=\"#' + tabid + '\"]';\n\n            document.querySelector(hrefSelector).click();\n\n            return true;\n        };\n\n        return true;\n    };\n\n    // No need.\n    const updateAutoCompletionPositions = function() {\n        var group = \"checkboxgroupautomation\";\n\n        if (document.querySelectorAll('input[type=checkbox].' + group)\n            === null || document.querySelectorAll('[data-fieldtype=\"autocomplete\"]') === null) {\n            return true;\n        }\n\n        document.querySelectorAll('[data-fieldtype=\"autocomplete\"]').forEach((element) => {\n\n            if (element === null) {\n                return true;\n            }\n\n            var observer = new MutationObserver(function(mutations) {\n                mutations.forEach((mutation) => {\n                    // Console.log(mutation);\n                    // If(mutation.type === 'attributes') {\n                    var target = mutation.target;\n                    var overrideElement = target.querySelector('.custom-switch');\n                    if (overrideElement === null) {\n                        return;\n                    }\n                    overrideElement.parentNode.append(overrideElement);\n                    observer.disconnect();\n                });\n            });\n            observer.observe(element, {attributes: true, childList: true, subtree: true});\n            // Observer.disconnect();\n            return true;\n        });\n\n        return true;\n    };\n\n    const moveOverRidePosition = function() {\n\n        var group = \"checkboxgroupautomation\";\n\n        if (document.querySelectorAll('input[type=checkbox].' + group) === null) {\n            return true;\n        }\n\n        document.querySelectorAll('input[type=checkbox].' + group).forEach((overElement) => {\n            var id = overElement.id;\n            id = id.replace('id_override_', '');\n            var element = document.querySelector('div#fitem_id_' + id);\n            if (element === null) {\n                element = document.querySelector('div#fgroup_id_' + id);\n                if (element === null) {\n                    return true;\n                }\n            }\n\n            var parent = overElement.parentNode;\n            parent.innerHTML += '<span class=\"custom-control-label\"></span>';\n\n            var nodeToMove = document.createElement('div');\n            nodeToMove.classList.add('custom-control', 'custom-switch');\n            nodeToMove.append(parent);\n            element.querySelector(\".felement\").append(nodeToMove);\n            return true;\n        });\n        // Move the override button for autocompletion fields after the autocomplete nodes are created.\n        updateAutoCompletionPositions();\n\n        return true;\n    };\n\n    /**\n     * Create a modal to display the list of instances which is overriden the template setting.\n     *\n     * @returns {void}\n     */\n    const overrideModal = function() {\n\n        // Add the template reference as prefix of the instance reference.\n        var templateReference = document.querySelector('#pulse-template-reference');\n        var instanceReference = document.querySelector('#fitem_id_insreference .felement');\n        if (templateReference && instanceReference) {\n            templateReference.classList.remove('hide');\n            instanceReference.prepend(templateReference);\n        }\n\n        const trigger = document.querySelectorAll('[data-target=\"overridemodal\"]');\n\n        if (trigger === null) {\n            return;\n        }\n\n        trigger.forEach((elem) => {\n\n            elem.nextSibling.querySelector('.felement').append(elem);\n\n            elem.addEventListener('click', function(e) {\n                e.preventDefault();\n                var element = e.target;\n                var data = element.dataset;\n                var instance = document.querySelector('[name=overinstance_' + data.element + ']');\n                if (instance !== null) {\n                    var overrides = JSON.parse(instance.value);\n                    overrides.map((value) => {\n                        var path = '/mod/pulse/automation/instances/edit.php?instanceid=';\n                        value.url = M.cfg.wwwroot + path + value.id + '&sesskey=' + M.cfg.sesskey;\n                        return value;\n                    });\n                    Modal.create({\n                        title: Str.get_string('instanceoverrides', 'pulse'),\n                        body: Template.render('mod_pulse/overrides', {instances: overrides})\n                    }).then((modal) => {\n                        modal.show();\n                        return true;\n                    }).catch();\n                }\n            });\n        });\n    };\n\n    const enableTitleOnSubmit = function() {\n        if (document.forms['pulse-automation-template'] === null) {\n            return;\n        }\n        document.forms['pulse-automation-template'].onsubmit =\n            () => document.querySelector('[name=\"title\"]').removeAttribute(\"disabled\");\n    };\n\n    return {\n\n        init: function() {\n            returnToFailedTab();\n            overrideModal();\n            moveOverRidePosition();\n            enableTitleOnSubmit();\n        },\n\n        instanceMenuLink: function() {\n            var primaryNav = document.querySelector('.secondary-navigation ul.more-nav');\n            moveOutMoreMenu(primaryNav);\n        },\n\n    };\n});\n"],"names":["define","$","Modal","Template","Str","moveOverRidePosition","group","document","querySelectorAll","forEach","overElement","id","replace","element","querySelector","parent","parentNode","innerHTML","nodeToMove","createElement","classList","add","append","observer","MutationObserver","mutations","mutation","overrideElement","target","disconnect","observe","attributes","childList","subtree","init","forms","onsubmit","e","invalidElement","hrefSelector","click","templateReference","instanceReference","remove","prepend","trigger","elem","nextSibling","addEventListener","preventDefault","data","dataset","instance","overrides","JSON","parse","value","map","url","M","cfg","wwwroot","sesskey","create","title","get_string","body","render","instances","then","modal","show","catch","overrideModal","removeAttribute","instanceMenuLink","navMenu","menu","forceintomoremenu","removeChild","insertBefore","children","window","dispatchEvent","Event","moveOutMoreMenu"],"mappings":"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"}