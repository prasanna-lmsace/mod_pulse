{"version":3,"file":"chaptersource.min.js","sources":["../src/chaptersource.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Frameworks datasource.\r\n *\r\n * This module is compatible with core/form-autocomplete.\r\n *\r\n * @module     tool_lp/frameworks_datasource\r\n * @copyright  2016 Frédéric Massart - FMCorz.net\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/modal_factory', 'core/fragment', 'core/str', 'core/modal_events'],\r\n    function($, Ajax, Notification, ModalFactory, Fragment, Str, ModalEvents) {\r\n\r\n    const previewModalBody = function(contextID, userid = null) {\r\n\r\n        var params;\r\n        if (window.tinyMCE !== undefined && window.tinyMCE.get('id_pulsenotification_headercontent_editor')) {\r\n            // EditorPlugin = window.tinyMCE;\r\n            params = {\r\n                contentheader: window.tinyMCE.get('id_pulsenotification_headercontent_editor').getContent(),\r\n                contentstatic: window.tinyMCE.get('id_pulsenotification_staticcontent_editor').getContent(),\r\n                contentfooter: window.tinyMCE.get('id_pulsenotification_footercontent_editor').getContent(),\r\n                userid: userid\r\n            };\r\n        } else {\r\n            // EditorPlugin = document;\r\n            params = {\r\n                contentheader: document.querySelector('#id_pulsenotification_headercontent_editoreditable').innerHTML,\r\n                contentstatic: document.querySelector('#id_pulsenotification_staticcontent_editoreditable').innerHTML,\r\n                contentfooter: document.querySelector('#id_pulsenotification_footercontent_editoreditable').innerHTML,\r\n                userid: userid\r\n            };\r\n        }\r\n\r\n        var dynamicparams = {};\r\n\r\n        if (document.querySelector('[name=pulsenotification_dynamiccontent]') !== null) {\r\n            dynamicparams = {\r\n                contentdynamic: document.querySelector('[name=pulsenotification_dynamiccontent]').value,\r\n                contenttype: document.querySelector('[name=pulsenotification_contenttype]').value,\r\n                chapterid: document.querySelector('[name=pulsenotification_chapterid]').value,\r\n                contentlength: document.querySelector('[name=pulsenotification_contentlength]').value,\r\n            };\r\n        }\r\n        // Get the form data.\r\n        var formData;\r\n        var form = document.forms['pulse-automation-template'];\r\n        var formdata = new FormData(form);\r\n        formdata = new URLSearchParams(formdata).toString();\r\n        formData = {\r\n            formdata: formdata\r\n        };\r\n\r\n        var finalParams = {...params, ...dynamicparams, ...formData};\r\n\r\n        return Fragment.loadFragment('pulseaction_notification', 'preview_content', contextID, finalParams);\r\n    };\r\n\r\n    const previewModal = function(contextID) {\r\n\r\n        ModalFactory.create({\r\n            title: Str.get_string('preview', 'pulseaction_notification'),\r\n            body: previewModalBody(contextID),\r\n            large: true,\r\n        }).then((modal) => {\r\n            modal.show();\r\n\r\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\r\n                modal.getRoot().get(0).querySelector('[name=userselector]').addEventListener('change', (e) => {\r\n                    e.preventDefault();\r\n                    var target = e.target;\r\n                    modal.setBody(previewModalBody(contextID, target.value));\r\n                });\r\n            });\r\n\r\n            return;\r\n        }).catch();\r\n    };\r\n\r\n    const notificationModal = function(contextID, instance, userid) {\r\n\r\n        var params = {\r\n            instanceid: instance,\r\n            userid: userid\r\n        };\r\n\r\n        ModalFactory.create({\r\n            title: Str.get_string('preview', 'pulseaction_notification'),\r\n            body: Fragment.loadFragment('pulseaction_notification', 'preview_instance_content', contextID, params),\r\n            large: true,\r\n        }).then((modal) => {\r\n            modal.show();\r\n            return;\r\n        }).catch();\r\n    };\r\n\r\n    return {\r\n\r\n        processResults: function(selector, modules) {\r\n            return modules;\r\n        },\r\n\r\n        transport: function(selector, query, success, failure) {\r\n\r\n            var mod = document.querySelector(\"#id_pulsenotification_dynamiccontent\");\r\n\r\n            var promise = Ajax.call([{\r\n                methodname: 'pulseaction_notification_get_chapters',\r\n                args: {mod: mod.value}\r\n            }]);\r\n\r\n            promise[0].then(function(result) {\r\n                success(result);\r\n                return;\r\n            }).fail(failure);\r\n        },\r\n\r\n        updateChapter: function(ctxID, contentMods) {\r\n\r\n            const SELECTORS = {\r\n                chaperType: \"#id_pulsenotification_contenttype\",\r\n                mod: \"#id_pulsenotification_dynamiccontent\"\r\n            };\r\n\r\n            // Disable the content type option for modules other than book and page.\r\n            if (contentMods !== null) {\r\n                var type = document.querySelector(SELECTORS.chaperType);\r\n                document.querySelector(SELECTORS.mod).addEventListener(\"change\", (e) => {\r\n                    var target = e.currentTarget;\r\n                    var selected = target.value;\r\n                    if (contentMods.includes(selected.toString())) {\r\n                        Array.prototype.find.call(type.options, function(cmid) {\r\n                            if (cmid.value == '2') {\r\n                                cmid.disabled = false;\r\n                            }\r\n                        });\r\n                    } else {\r\n                        Array.prototype.find.call(type.options, function(cmid) {\r\n                            if (cmid.value == '2') {\r\n                                cmid.disabled = true;\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n\r\n            document.querySelector(SELECTORS.chaperType).addEventListener(\"change\", () => resetChapter());\r\n            document.querySelector(SELECTORS.mod).addEventListener(\"change\", () => resetChapter());\r\n            var chapter = document.querySelector(\"#id_pulsenotification_chapterid\");\r\n\r\n            /**\r\n             *\r\n             */\r\n            function resetChapter() {\r\n                chapter.innerHTML = '';\r\n                chapter.value = '';\r\n                var event = new Event('change');\r\n                chapter.dispatchEvent(event);\r\n            }\r\n        },\r\n\r\n        previewNotification: function(contextid) {\r\n\r\n            var btn = document.querySelector('[name=\"pulsenotification_preview\"]');\r\n\r\n            if (btn === null) {\r\n                return;\r\n            }\r\n\r\n            btn.addEventListener('click', function() {\r\n                previewModal(contextid);\r\n            });\r\n        },\r\n\r\n        reportModal: function(contextID) {\r\n            // View content.\r\n            /* var btn = document.querySelectorAll('[data-target=\"view-content\"]');\r\n\r\n            if (btn === null) {\r\n                return;\r\n            }\r\n\r\n            btn.forEach((element) => {\r\n                element.addEventListener('click', function(e) {\r\n\r\n                    var target = e.target.closest('a');\r\n\r\n                    var instance = target.dataset.instanceid;\r\n                    var userid = target.dataset.userid;\r\n\r\n                    notificationModal(contextID, instance, userid); // Notification modal.\r\n                });\r\n            });\r\n */\r\n\r\n            document.addEventListener('click', function(e) {\r\n\r\n                if (e.target.closest('[data-target=\"view-content\"]') !== null) {\r\n\r\n                    var target = e.target.closest('a');\r\n\r\n                    var instance = target.dataset.instanceid;\r\n                    var userid = target.dataset.userid;\r\n\r\n                    notificationModal(contextID, instance, userid); // Notification modal.\r\n                }\r\n\r\n            })\r\n        }\r\n    };\r\n\r\n});\r\n"],"names":["define","$","Ajax","Notification","ModalFactory","Fragment","Str","ModalEvents","previewModalBody","contextID","userid","params","undefined","window","tinyMCE","get","contentheader","getContent","contentstatic","contentfooter","document","querySelector","innerHTML","formData","dynamicparams","contentdynamic","value","contenttype","chapterid","contentlength","form","forms","formdata","FormData","URLSearchParams","toString","finalParams","loadFragment","processResults","selector","modules","transport","query","success","failure","mod","call","methodname","args","then","result","fail","updateChapter","ctxID","contentMods","SELECTORS","type","addEventListener","e","selected","currentTarget","includes","Array","prototype","find","options","cmid","disabled","resetChapter","chapter","event","Event","dispatchEvent","previewNotification","contextid","btn","create","title","get_string","body","large","modal","show","getRoot","on","bodyRendered","preventDefault","target","setBody","catch","reportModal","closest","instance","dataset","instanceid","notificationModal"],"mappings":"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"}